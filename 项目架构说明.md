# Squirrel 鼠鬚管输入法项目架构说明

## 📋 项目概述

Squirrel（鼠鬚管）是基于 Rime 输入法引擎的 macOS 输入法，采用 Swift + Objective-C 混合开发，使用 Input Method Kit 框架实现。

## 🏗️ 整体项目结构

```
squirrel/
├── sources/                    # 🎯 核心源代码目录
├── librime/                    # 📚 Rime 输入法引擎（Git 子模块）
├── plum/                       # 🌸 输入方案配置管理器（Git 子模块）
├── Sparkle/                    # ✨ 自动更新框架（Git 子模块）
├── Frameworks/                 # 📦 编译后的框架文件
├── lib/                        # 📚 动态库和插件
├── bin/                        # 🛠️ 可执行工具
├── data/                       # 📄 配置文件和数据
├── resources/                  # 🎨 应用资源文件
├── Assets.xcassets/           # 🖼️ 图标资源
├── package/                    # 📦 打包相关脚本
├── scripts/                    # 📜 安装后脚本
├── Squirrel.xcodeproj/        # 🏗️ Xcode 项目文件
├── Makefile                    # 🔨 构建脚本
├── action-install.sh          # 🚀 快速安装脚本
└── 各种配置文件...
```

## 📂 核心源代码目录 (sources/)

### 🎯 应用程序入口
- **`Main.swift`**
  - 应用程序主入口点
  - 定义 `@main SquirrelApp` 结构体
  - 配置用户目录和应用目录路径
  - 初始化输入法服务

### 🎛️ 应用程序管理
- **`SquirrelApplicationDelegate.swift`**
  - 应用程序生命周期管理
  - Sparkle 自动更新功能集成
  - 用户通知处理
  - Rime API 初始化和配置
  - 菜单栏功能实现

### ⌨️ 输入法核心逻辑
- **`SquirrelInputController.swift`**
  - 输入法控制器主类
  - 键盘事件处理
  - 文本输入和候选词管理
  - 与 Rime 引擎的交互
  - 输入状态管理

### 🎨 用户界面组件
- **`SquirrelPanel.swift`**
  - 候选词面板窗口
  - 窗口位置和显示管理
  - 面板样式配置

- **`SquirrelView.swift`**
  - 候选词显示视图
  - 文本渲染和布局
  - 用户交互处理

- **`SquirrelTheme.swift`**
  - 主题系统实现
  - 颜色、字体、样式管理
  - 主题配置解析

### ⚙️ 配置和工具
- **`SquirrelConfig.swift`**
  - 配置文件读取和解析
  - 设置项管理
  - 配置变更监听

- **`InputSource.swift`**
  - 输入源管理
  - 输入法切换逻辑
  - 系统集成功能

- **`MacOSKeyCodes.swift`**
  - macOS 按键码定义和映射
  - 键盘事件转换
  - 特殊键处理

### 🔗 桥接层
- **`BridgingFunctions.swift`**
  - Swift 与 C/C++ 库的桥接函数
  - Rime API 包装
  - 内存管理辅助

- **`Squirrel-Bridging-Header.h`**
  - Objective-C/C 头文件桥接
  - 引入 Rime API 定义
  - 系统库声明

## 📦 依赖项和子模块

### 📚 librime/ (Git 子模块)
- **作用**: Rime 输入法引擎核心库
- **功能**: 
  - 拼音、注音等输入方案处理
  - 词典管理和候选词生成
  - 用户词频学习
- **编译产物**: `lib/librime.1.dylib`

### 🌸 plum/ (Git 子模块)
- **作用**: 输入方案配置管理器（东风破）
- **功能**:
  - 输入方案下载和安装
  - 配置文件管理
  - 词典数据提供
- **重要文件**: `bin/rime-install`

### ✨ Sparkle/ (Git 子模块)
- **作用**: 自动更新框架
- **功能**:
  - 应用程序自动更新
  - 版本检查和下载
  - 用户更新提示
- **编译产物**: `Frameworks/Sparkle.framework`

## 🛠️ 构建产物目录

### 📚 lib/
```
lib/
├── librime.1.dylib           # Rime 引擎动态库
└── rime-plugins/             # Rime 插件目录
    ├── librime-lua.dylib     # Lua 脚本支持
    ├── librime-octagram.dylib # 八股文语言模型
    └── librime-predict.dylib  # 预测输入
```

### 🛠️ bin/
```
bin/
├── rime_deployer           # Rime 部署工具
├── rime_dict_manager       # 词典管理工具
└── rime-install           # 输入方案安装工具
```

### 📄 data/
```
data/
├── squirrel.yaml          # Squirrel 主配置文件
├── opencc/                # 简繁转换数据
│   ├── TSCharacters.ocd2  # 繁简字符映射
│   ├── TSPhrases.ocd2     # 繁简词组映射
│   └── t2s.json          # 转换配置
└── plum/                  # 输入方案数据
    ├── default.yaml       # 默认配置
    ├── symbols.yaml       # 符号定义
    ├── essay.txt          # 八股文语料
    └── 各种输入方案文件...
```

## 🎨 资源文件

### 🖼️ Assets.xcassets/
- **RimeIcon.appiconset/**: 应用程序图标集
  - 包含各种尺寸的图标文件（16x16 到 1024x1024）

### 📋 resources/
- **Info.plist**: 应用程序信息配置
- **InfoPlist.xcstrings**: 本地化字符串（Info.plist）
- **Localizable.xcstrings**: 应用程序本地化字符串
- **Squirrel.entitlements**: 应用程序权限配置
- **rime.pdf**: 帮助文档

## 🔨 构建和部署

### 📜 核心脚本
- **`Makefile`**: 主构建脚本
  - 依赖项构建管理
  - 库文件复制和链接
  - 打包和签名

- **`action-install.sh`**: 快速安装脚本
  - 下载预编译的 librime
  - 下载 Sparkle 框架
  - 安装默认输入方案

### 📦 package/
- **`make_package`**: 创建安装包
- **`sign_app`**: 应用程序签名
- **`add_data_files`**: 添加数据文件到应用包

### 📜 scripts/
- **`postinstall`**: 安装后脚本
  - 注册输入法
  - 设置权限

## 🏃‍♂️ 开发工作流

### 1. 环境准备
```bash
# 初始化子模块
git submodule update --init --recursive

# 快速安装依赖
bash ./action-install.sh
```

### 2. 编译项目
```bash
# 使用 Make 构建
make release

# 或在 Xcode 中构建
open Squirrel.xcodeproj
```

### 3. 主要开发文件
- 核心逻辑修改: `sources/SquirrelInputController.swift`
- UI 界面修改: `sources/SquirrelPanel.swift`, `sources/SquirrelView.swift`
- 主题样式修改: `sources/SquirrelTheme.swift`
- 配置管理修改: `sources/SquirrelConfig.swift`

## 🔍 技术栈

- **主要语言**: Swift 5.0
- **UI 框架**: AppKit (macOS)
- **输入法框架**: Input Method Kit
- **自动更新**: Sparkle Framework
- **输入引擎**: Rime (C++)
- **构建系统**: Xcode + Make
- **包管理**: Git Submodules

## 📝 配置文件说明

### 主要配置文件
- **`data/squirrel.yaml`**: Squirrel 应用程序配置
- **`data/plum/default.yaml`**: Rime 默认配置
- **`resources/Info.plist`**: 应用程序元数据

### 用户配置目录
- **`~/Library/Rime/`**: 用户个人配置和数据
  - `default.custom.yaml`: 用户自定义配置
  - `squirrel.custom.yaml`: Squirrel 自定义配置
  - 各种用户词典和日志文件

---

📅 **文档生成时间**: 2025年8月20日  
📝 **维护说明**: 本文档基于当前项目结构生成，如有变更请及时更新
