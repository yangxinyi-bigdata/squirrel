# Squirrel 源码阅读指南

## 🎯 推荐阅读顺序

### 第一阶段：理解项目结构和入口点 (30分钟)

#### 1. **Main.swift** - 项目入口 ⭐⭐⭐⭐⭐
```
sources/Main.swift
```
**为什么先读这个：**
- 应用程序的入口点，了解应用如何启动
- 理解目录结构和基本配置
- 看到 Input Method Kit 的初始化过程

**重点关注：**
- `SquirrelApp` 结构体
- `userDir` 和 `appDir` 的定义
- `IMKServer` 的初始化

#### 2. **SquirrelApplicationDelegate.swift** - 应用程序委托 ⭐⭐⭐⭐⭐
```
sources/SquirrelApplicationDelegate.swift
```
**为什么接着读：**
- 应用程序生命周期管理
- Rime API 的初始化和配置
- 菜单功能实现

**重点关注：**
- `applicationDidFinishLaunching` 方法
- Rime API 初始化过程
- 菜单栏功能实现
- Sparkle 更新机制

### 第二阶段：理解输入法核心机制 (60分钟)

#### 3. **SquirrelInputController.swift** - 输入法核心 ⭐⭐⭐⭐⭐
```
sources/SquirrelInputController.swift (568行)
```
**这是最重要的文件！**

**建议分段阅读：**
```swift
// 第一段：类定义和属性 (1-50行)
- 了解核心属性和状态管理

// 第二段：输入处理 (100-300行)
- handle(event:client:) 方法
- 键盘事件处理逻辑

// 第三段：候选词管理 (300-400行)
- updateCandidates() 方法
- 候选词显示逻辑

// 第四段：文本提交 (400-568行)
- commitText() 相关方法
- 文本输出处理
```

**重点关注：**
- `handle(event:client:)` - 核心事件处理
- `updateCandidates()` - 候选词更新
- Rime Session 管理
- 输入状态切换

#### 4. **BridgingFunctions.swift** - C/Swift 桥接 ⭐⭐⭐⭐
```
sources/BridgingFunctions.swift
```
**为什么现在读：**
- 理解 Swift 如何调用 Rime C API
- 了解内存管理和数据转换

**重点关注：**
- Rime API 包装函数
- 字符串转换处理
- 内存管理方式

#### 5. **Squirrel-Bridging-Header.h** - C头文件桥接 ⭐⭐⭐
```
sources/Squirrel-Bridging-Header.h
```
**快速浏览：**
- 了解引入了哪些 C 库
- 理解 Rime API 的结构

### 第三阶段：理解用户界面和显示 (45分钟)

#### 6. **SquirrelPanel.swift** - 候选词面板 ⭐⭐⭐⭐
```
sources/SquirrelPanel.swift
```
**重点关注：**
- 面板窗口的创建和管理
- 位置计算逻辑
- 与 SquirrelView 的协作

#### 7. **SquirrelView.swift** - 候选词视图 ⭐⭐⭐⭐
```
sources/SquirrelView.swift
```
**重点关注：**
- 候选词的绘制逻辑
- 文本布局和排版
- 鼠标交互处理

#### 8. **SquirrelTheme.swift** - 主题系统 ⭐⭐⭐
```
sources/SquirrelTheme.swift
```
**重点关注：**
- 主题配置解析
- 颜色和字体管理
- 样式应用逻辑

### 第四阶段：理解配置和系统集成 (30分钟)

#### 9. **SquirrelConfig.swift** - 配置管理 ⭐⭐⭐
```
sources/SquirrelConfig.swift
```
**重点关注：**
- YAML 配置文件解析
- 配置项的读取和应用
- 配置变更监听

#### 10. **InputSource.swift** - 输入源管理 ⭐⭐
```
sources/InputSource.swift
```
**重点关注：**
- 输入法切换逻辑
- 系统输入源集成

#### 11. **MacOSKeyCodes.swift** - 按键映射 ⭐⭐
```
sources/MacOSKeyCodes.swift
```
**快速浏览：**
- 理解按键码映射
- 特殊键处理

## 🔍 深度阅读建议

### 核心流程理解
阅读完上述文件后，重点理解这几个核心流程：

#### 1. **应用启动流程**
```
Main.swift → SquirrelApplicationDelegate.swift
```

#### 2. **输入处理流程**
```
SquirrelInputController.handle(event:client:) 
→ BridgingFunctions (调用 Rime API)
→ updateCandidates()
→ SquirrelPanel/SquirrelView (显示候选词)
```

#### 3. **配置加载流程**
```
SquirrelConfig → SquirrelTheme → SquirrelPanel/SquirrelView
```

## 📖 阅读技巧

### 1. **使用 Xcode 的导航功能**
- `Cmd + Shift + O`: 快速打开文件
- `Cmd + Ctrl + J`: 跳转到定义
- `Cmd + Ctrl + ←/→`: 前进/后退

### 2. **重点关注的设计模式**
- **委托模式**: ApplicationDelegate, InputController
- **观察者模式**: 配置变更监听
- **桥接模式**: Swift/C API 桥接
- **单例模式**: 配置管理

### 3. **理解关键概念**
- **Rime Session**: 输入会话管理
- **IMK Framework**: macOS 输入法框架
- **候选词**: Candidate 的生成和显示
- **Preedit**: 预编辑文本

## 🎯 学习目标

### 初级目标 (完成1-2阶段)
- 理解应用程序启动和基本结构
- 了解输入法的工作原理

### 中级目标 (完成1-3阶段)  
- 理解完整的输入处理流程
- 能够进行简单的功能修改

### 高级目标 (完成全部)
- 理解整个系统架构
- 能够添加新功能和优化性能

## ⚡ 快速上手路径

如果时间有限，建议按这个顺序快速浏览：

1. **Main.swift** (10分钟) - 了解入口
2. **SquirrelInputController.swift** 的 `handle(event:client:)` 方法 (20分钟) - 理解核心逻辑
3. **SquirrelApplicationDelegate.swift** 的菜单部分 (15分钟) - 了解功能特性

这样 45分钟就能对项目有基本理解！

---

📝 **提示**: 建议在阅读过程中做笔记，记录关键的函数调用链和数据流向，这样有助于更好地理解整个系统。
